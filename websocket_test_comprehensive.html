<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket Comprehensive Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .form-group {
        margin-bottom: 10px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
      }
      button:hover {
        opacity: 0.9;
      }
      button.disconnect {
        background-color: #f44336;
      }
      .log {
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: #f9f9f9;
        font-family: monospace;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .info {
        color: blue;
      }
      .tabs {
        display: flex;
        gap: 10px;
      }
      .tab {
        padding: 10px 15px;
        border: 1px solid #ccc;
        border-radius: 4px 4px 0 0;
        cursor: pointer;
      }
      .tab.active {
        background-color: #f0f0f0;
        border-bottom: none;
      }
      .tab-content {
        border: 1px solid #ccc;
        border-radius: 0 4px 4px 4px;
        padding: 15px;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>WebSocket Comprehensive Test</h1>

    <div class="container">
      <div class="card">
        <h2>Connection Settings</h2>
        <div class="form-group">
          <label for="sessionid">Session ID (từ cookie nếu cần):</label>
          <input
            type="text"
            id="sessionid"
            placeholder="Nhập session ID từ cookie"
          />
        </div>
        <div class="tabs">
          <div class="tab active" onclick="showTab('thread-tab')">
            Thread Connection
          </div>
          <div class="tab" onclick="showTab('user-tab')">
            User Notification Connection
          </div>
        </div>

        <div id="thread-tab" class="tab-content">
          <div class="form-group">
            <label for="threadId">Thread ID:</label>
            <input type="number" id="threadId" value="1" />
          </div>
          <div class="btn-group">
            <button onclick="connectThreadWebSocket()">
              Connect to Thread
            </button>
            <button class="disconnect" onclick="disconnectThreadWebSocket()">
              Disconnect
            </button>
          </div>
        </div>

        <div id="user-tab" class="tab-content hidden">
          <div class="form-group">
            <label for="userId">User ID:</label>
            <input type="number" id="userId" value="1" />
          </div>
          <div class="btn-group">
            <button onclick="connectUserWebSocket()">
              Connect to User Notifications
            </button>
            <button class="disconnect" onclick="disconnectUserWebSocket()">
              Disconnect
            </button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Test Actions</h2>
        <div class="form-group">
          <label for="actionType">Action Type:</label>
          <select id="actionType">
            <option value="like_thread">Like a Thread</option>
            <option value="comment_thread">Comment on a Thread</option>
            <option value="like_comment">Like a Comment</option>
            <option value="reply_comment">Reply to a Comment</option>
          </select>
        </div>

        <div class="action-form" id="like-thread-form">
          <div class="form-group">
            <label for="likeThreadId">Thread ID to Like:</label>
            <input type="number" id="likeThreadId" />
          </div>
        </div>

        <div class="action-form hidden" id="comment-thread-form">
          <div class="form-group">
            <label for="commentThreadId">Thread ID to Comment:</label>
            <input type="number" id="commentThreadId" />
          </div>
          <div class="form-group">
            <label for="commentContent">Comment Content:</label>
            <input
              type="text"
              id="commentContent"
              placeholder="Enter your comment"
            />
          </div>
        </div>

        <div class="action-form hidden" id="like-comment-form">
          <div class="form-group">
            <label for="likeCommentThreadId">Thread ID:</label>
            <input type="number" id="likeCommentThreadId" />
          </div>
          <div class="form-group">
            <label for="likeCommentId">Comment ID to Like:</label>
            <input type="number" id="likeCommentId" />
          </div>
        </div>

        <div class="action-form hidden" id="reply-comment-form">
          <div class="form-group">
            <label for="replyThreadId">Thread ID:</label>
            <input type="number" id="replyThreadId" />
          </div>
          <div class="form-group">
            <label for="replyCommentId">Parent Comment ID:</label>
            <input type="number" id="replyCommentId" />
          </div>
          <div class="form-group">
            <label for="replyContent">Reply Content:</label>
            <input
              type="text"
              id="replyContent"
              placeholder="Enter your reply"
            />
          </div>
        </div>

        <div class="btn-group">
          <button onclick="performAction()">Perform Action</button>
        </div>
      </div>

      <div class="card">
        <h2>WebSocket Log</h2>
        <div class="log" id="log"></div>
      </div>
    </div>

    <script>
      let threadSocket = null;
      let userSocket = null;

      // Show/hide tabs
      function showTab(tabId) {
        document
          .querySelectorAll(".tab-content")
          .forEach((tab) => tab.classList.add("hidden"));
        document
          .querySelectorAll(".tab")
          .forEach((tab) => tab.classList.remove("active"));

        document.getElementById(tabId).classList.remove("hidden");
        document
          .querySelector(`[onclick="showTab('${tabId}')"]`)
          .classList.add("active");
      }

      // Show/hide action forms based on selection
      document
        .getElementById("actionType")
        .addEventListener("change", function () {
          document
            .querySelectorAll(".action-form")
            .forEach((form) => form.classList.add("hidden"));

          const action = this.value;
          if (action === "like_thread") {
            document
              .getElementById("like-thread-form")
              .classList.remove("hidden");
          } else if (action === "comment_thread") {
            document
              .getElementById("comment-thread-form")
              .classList.remove("hidden");
          } else if (action === "like_comment") {
            document
              .getElementById("like-comment-form")
              .classList.remove("hidden");
          } else if (action === "reply_comment") {
            document
              .getElementById("reply-comment-form")
              .classList.remove("hidden");
          }
        });

      function log(message, type = "normal") {
        const logDiv = document.getElementById("log");
        const line = document.createElement("div");
        line.classList.add(type);
        const timestamp = new Date().toLocaleTimeString();
        line.textContent = `[${timestamp}] ${message}`;
        logDiv.appendChild(line);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function connectThreadWebSocket() {
        const threadId = document.getElementById("threadId").value;
        const sessionId = document.getElementById("sessionid").value;

        log(
          `Connecting to Thread WebSocket: ws://127.0.0.1:8000/ws/thread/${threadId}/`,
          "info"
        );

        threadSocket = new WebSocket(
          `ws://127.0.0.1:8000/ws/thread/${threadId}/`
        );

        if (sessionId) {
          log(`Using session ID: ${sessionId}`, "info");
          document.cookie = `sessionid=${sessionId}; path=/`;
        }

        threadSocket.onopen = function (e) {
          log("Thread Connection established!", "success");
        };

        threadSocket.onmessage = function (event) {
          log(`Thread Data received: ${event.data}`);
          try {
            const data = JSON.parse(event.data);
            log(
              `Parsed thread data: ${JSON.stringify(data, null, 2)}`,
              "success"
            );
          } catch (e) {
            log("Error parsing data", "error");
          }
        };

        threadSocket.onclose = function (event) {
          if (event.wasClean) {
            log(
              `Thread Connection closed cleanly, code=${event.code} reason=${event.reason}`,
              "info"
            );
          } else {
            log("Thread Connection died", "error");
          }
        };

        threadSocket.onerror = function (error) {
          log(`Thread Connection Error: ${error.message}`, "error");
        };
      }

      function connectUserWebSocket() {
        const userId = document.getElementById("userId").value;
        const sessionId = document.getElementById("sessionid").value;

        log(
          `Connecting to User WebSocket: ws://127.0.0.1:8000/ws/user/${userId}/`,
          "info"
        );

        userSocket = new WebSocket(`ws://127.0.0.1:8000/ws/user/${userId}/`);

        if (sessionId) {
          log(`Using session ID: ${sessionId}`, "info");
          document.cookie = `sessionid=${sessionId}; path=/`;
        }

        userSocket.onopen = function (e) {
          log("User Connection established!", "success");
        };

        userSocket.onmessage = function (event) {
          log(`User Data received: ${event.data}`);
          try {
            const data = JSON.parse(event.data);
            log(
              `Parsed user data: ${JSON.stringify(data, null, 2)}`,
              "success"
            );
          } catch (e) {
            log("Error parsing data", "error");
          }
        };

        userSocket.onclose = function (event) {
          if (event.wasClean) {
            log(
              `User Connection closed cleanly, code=${event.code} reason=${event.reason}`,
              "info"
            );
          } else {
            log("User Connection died", "error");
          }
        };

        userSocket.onerror = function (error) {
          log(`User Connection Error: ${error.message}`, "error");
        };
      }

      function disconnectThreadWebSocket() {
        if (threadSocket) {
          log("Disconnecting thread...", "info");
          threadSocket.close();
          threadSocket = null;
        } else {
          log("No active thread connection", "error");
        }
      }

      function disconnectUserWebSocket() {
        if (userSocket) {
          log("Disconnecting user...", "info");
          userSocket.close();
          userSocket = null;
        } else {
          log("No active user connection", "error");
        }
      }

      function performAction() {
        const action = document.getElementById("actionType").value;
        let url = "";
        let method = "POST";
        let data = {};

        if (action === "like_thread") {
          const threadId = document.getElementById("likeThreadId").value;
          url = `/api/threads/${threadId}/like/`;
          log(`Sending like request for thread ${threadId}`, "info");
        } else if (action === "comment_thread") {
          const threadId = document.getElementById("commentThreadId").value;
          const content = document.getElementById("commentContent").value;
          url = `/api/threads/${threadId}/comments/`;
          data = { content };
          log(`Creating comment on thread ${threadId}: "${content}"`, "info");
        } else if (action === "like_comment") {
          const threadId = document.getElementById("likeCommentThreadId").value;
          const commentId = document.getElementById("likeCommentId").value;
          url = `/api/threads/${threadId}/comments/${commentId}/like/`;
          log(
            `Sending like request for comment ${commentId} on thread ${threadId}`,
            "info"
          );
        } else if (action === "reply_comment") {
          const threadId = document.getElementById("replyThreadId").value;
          const parentCommentId =
            document.getElementById("replyCommentId").value;
          const content = document.getElementById("replyContent").value;
          url = `/api/threads/${threadId}/comments/`;
          data = { content, parent_comment: parentCommentId };
          log(
            `Creating reply to comment ${parentCommentId} on thread ${threadId}: "${content}"`,
            "info"
          );
        }

        // Make the request
        log(`Sending ${method} request to ${url}`, "info");

        fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: Object.keys(data).length ? JSON.stringify(data) : undefined,
          credentials: "same-origin",
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            log(
              `Action completed successfully. Response: ${JSON.stringify(
                data
              )}`,
              "success"
            );
          })
          .catch((error) => {
            log(`Error performing action: ${error.message}`, "error");
          });
      }

      // Helper function to get cookies
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // Initialize
      document.getElementById("like-thread-form").classList.remove("hidden");
    </script>
  </body>
</html>
